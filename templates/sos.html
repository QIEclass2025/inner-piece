{% extends "base.html" %}

{% block content %}
<div style="max-width: 600px; margin: 0 auto; text-align: center;">
    <h1 style="margin-bottom: 2rem;">SOS: 4-7-8 호흡</h1>

    <!-- Setup Screen -->
    <div id="setup-screen" class="card">
        <h3>시간 선택</h3>
        <p style="margin-bottom: 2rem; color: var(--muted-text);">원하는 호흡 시간을 선택하세요.</p>

        <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 2rem;">
            <button class="btn btn-secondary" onclick="startBreathing(1)">1분 (3회)</button>
            <button class="btn btn-secondary" onclick="startBreathing(2)">2분 (6회)</button>
            <button class="btn btn-secondary" onclick="startBreathing(3)">3분 (9회)</button>
        </div>
        <p style="font-size: 0.9rem; color: var(--muted-text);">4초간 들이마시고, 7초간 멈추고, 8초간 내뱉습니다.</p>
    </div>

    <!-- Breathing Screen -->
    <div id="breathing-screen" style="display: none;">
        <div class="breathing-container"
            style="position: relative; height: 300px; display: flex; align-items: center; justify-content: center; margin-bottom: 2rem;">
            <div id="breathing-circle"
                style="width: 150px; height: 150px; background: var(--accent-color); border-radius: 50%; opacity: 0.8; transition: all 1s ease;">
            </div>
            <div id="instruction-text"
                style="position: absolute; font-size: 1.5rem; font-weight: bold; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                준비</div>
        </div>
        <p id="cycle-count" style="margin-bottom: 1rem; color: var(--muted-text);">Cycle 1/3</p>
        <button class="btn btn-secondary" onclick="stopBreathing()" style="font-size: 0.9rem;">중단하기</button>
    </div>

    <!-- Grounding Screen -->
    <div id="grounding-screen" class="card" style="display: none; text-align: left;">
        <h3 style="text-align: center; margin-bottom: 1rem;">그라운딩 (현실감 회복)</h3>
        <p style="text-align: center; margin-bottom: 2rem; color: var(--muted-text);">주변을 둘러보며 천천히 입력해보세요.</p>

        <div style="margin-bottom: 1rem;">
            <label>1. 눈에 보이는 것 5가지</label>
            <input type="text" id="g-sight"
                style="width: 100%; padding: 0.5rem; margin-top: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div style="margin-bottom: 1rem;">
            <label>2. 느껴지는 촉감 4가지</label>
            <input type="text" id="g-touch"
                style="width: 100%; padding: 0.5rem; margin-top: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div style="margin-bottom: 1rem;">
            <label>3. 들리는 소리 3가지</label>
            <input type="text" id="g-sound"
                style="width: 100%; padding: 0.5rem; margin-top: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div style="margin-bottom: 1rem;">
            <label>4. 맡을 수 있는 냄새 2가지</label>
            <input type="text" id="g-smell"
                style="width: 100%; padding: 0.5rem; margin-top: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div style="margin-bottom: 1rem;">
            <label>5. 느껴지는 맛 1가지</label>
            <input type="text" id="g-taste"
                style="width: 100%; padding: 0.5rem; margin-top: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div style="margin-bottom: 2rem;">
            <label>메모 (선택)</label>
            <textarea id="memo"
                style="width: 100%; padding: 0.5rem; margin-top: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"></textarea>
        </div>

        <div style="text-align: center;">
            <button class="btn" onclick="saveRecord()">저장하고 마치기</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let totalCycles = 0;
    let currentCycle = 0;
    let isRunning = false;
    let selectedCourse = 0;

    function startBreathing(minutes) {
        selectedCourse = minutes;
        totalCycles = minutes * 3;
        currentCycle = 1;
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('breathing-screen').style.display = 'block';

        runCycle();
    }

    function stopBreathing() {
        isRunning = false;
        location.reload();
    }

    function updateCircleScale(scale, duration) {
        const circle = document.getElementById('breathing-circle');
        circle.style.transition = `transform ${duration}s ease-in-out`;
        circle.style.transform = `scale(${scale})`;
    }

    async function runPhase(scale, baseText, duration) {
        if (!isRunning) return;

        // Start animation
        updateCircleScale(scale, duration);

        const label = document.getElementById('instruction-text');

        // Countdown loop
        for (let i = duration; i > 0; i--) {
            if (!isRunning) break;
            label.innerText = `${baseText} (${i})`;
            await new Promise(r => setTimeout(r, 1000));
        }
    }

    async function runCycle() {
        if (currentCycle > totalCycles) {
            showGrounding();
            return;
        }

        document.getElementById('cycle-count').innerText = `Cycle ${currentCycle}/${totalCycles}`;
        isRunning = true;

        // Inhale (4s)
        await runPhase(1.5, "들이마시기", 4);
        if (!isRunning) return;

        // Hold (7s)
        await runPhase(1.5, "멈춤", 7);
        if (!isRunning) return;

        // Exhale (8s)
        await runPhase(1.0, "내뱉기", 8);
        if (!isRunning) return;

        currentCycle++;
        runCycle();
    }

    function showGrounding() {
        document.getElementById('breathing-screen').style.display = 'none';
        document.getElementById('grounding-screen').style.display = 'block';
    }

    function saveRecord() {
        const data = {
            course: `약 ${selectedCourse}분`,
            memo: document.getElementById('memo').value,
            grounding: {
                sight: document.getElementById('g-sight').value,
                touch: document.getElementById('g-touch').value,
                sound: document.getElementById('g-sound').value,
                smell: document.getElementById('g-smell').value,
                taste: document.getElementById('g-taste').value
            }
        };

        fetch('/api/save_sos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('저장되었습니다.');
                    window.location.href = "{{ url_for('home') }}";
                } else {
                    alert('저장 실패');
                }
            });
    }
</script>
{% endblock %}