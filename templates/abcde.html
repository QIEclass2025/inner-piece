{% extends "base.html" %}

{% block content %}
<div class="card" style="max-width: 800px; margin: 0 auto;">
    <h2 style="text-align: center; margin-bottom: 2rem;">ABCDE 사고 전환 훈련</h2>

    <!-- Progress Bar -->
    <div
        style="display: flex; justify-content: space-between; margin-bottom: 2rem; color: var(--muted-text); font-weight: bold;">
        <span id="step-A" class="step-indicator active">A 사건</span>
        <span id="step-B" class="step-indicator">B 믿음</span>
        <span id="step-C" class="step-indicator">C 결과</span>
        <span id="step-D" class="step-indicator">D 논박</span>
        <span id="step-E" class="step-indicator">E 효과</span>
    </div>

    <form id="abcde-form" onsubmit="return false;">
        <!-- Step A -->
        <div class="wizard-step" id="step-A-content">
            <h3>[A] Adversity (사건)</h3>
            <p>스트레스를 유발한 구체적인 사건은 무엇인가요?</p>
            <textarea id="adversity" rows="4"
                style="width: 100%; margin-top: 1rem; padding: 1rem; border: 1px solid #ddd; border-radius: 8px;"></textarea>
            <div style="text-align: right; margin-top: 1rem;">
                <button class="btn" onclick="nextStep('B')">다음</button>
            </div>
        </div>

        <!-- Step B -->
        <div class="wizard-step" id="step-B-content" style="display: none;">
            <h3>[B] Belief (믿음)</h3>
            <p>그 사건에 대해 어떤 생각이 드셨나요?</p>
            <textarea id="belief" rows="4"
                style="width: 100%; margin-top: 1rem; padding: 1rem; border: 1px solid #ddd; border-radius: 8px;"></textarea>
            <div style="display: flex; justify-content: space-between; margin-top: 1rem;">
                <button class="btn btn-secondary" onclick="prevStep('A')">이전</button>
                <button class="btn" onclick="nextStep('C')">다음</button>
            </div>
        </div>

        <!-- Step C -->
        <div class="wizard-step" id="step-C-content" style="display: none;">
            <h3>[C] Consequence (결과)</h3>
            <p>그 생각으로 인해 느껴지는 감정이나 신체 반응은 무엇인가요? (고통 점수 1~10)</p>
            <input type="number" id="consequence" min="1" max="10"
                style="width: 100px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 8px; margin-top: 1rem;">
            <div style="display: flex; justify-content: space-between; margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="prevStep('B')">이전</button>
                <button class="btn" onclick="nextStep('D')">다음</button>
            </div>
        </div>

        <!-- Step D -->
        <div class="wizard-step" id="step-D-content" style="display: none;">
            <h3>[D] Disputation (논박)</h3>
            <div class="card"
                style="background: rgba(44, 62, 80, 0.05); border: none; margin-bottom: 1rem; position: relative;">
                <p><strong>💡 질문:</strong> <span id="ai-question">{{ initial_question }}</span></p>
                <div style="text-align: right; margin-top: 0.5rem;">
                    <button type="button" class="btn btn-secondary" style="font-size: 0.8rem; padding: 0.3rem 0.8rem;"
                        onclick="refreshQuestion()">
                        <i class="fa-solid fa-arrows-rotate"></i> 다른 질문 보기
                    </button>
                </div>
            </div>
            <p>위 질문을 참고하여, 기존 생각(B)을 반박해보세요.</p>
            <textarea id="disputation" rows="4"
                style="width: 100%; margin-top: 1rem; padding: 1rem; border: 1px solid #ddd; border-radius: 8px;"></textarea>
            <div style="display: flex; justify-content: space-between; margin-top: 1rem;">
                <button class="btn btn-secondary" onclick="prevStep('C')">이전</button>
                <button class="btn" onclick="nextStep('E')">다음</button>
            </div>
        </div>

        <!-- Step E -->
        <div class="wizard-step" id="step-E-content" style="display: none;">
            <h3>[E] Effect (효과)</h3>
            <p>논박을 통해 새롭게 정리된 합리적인 생각이나 기분은 어떤가요?</p>
            <textarea id="effect" rows="4"
                style="width: 100%; margin-top: 1rem; padding: 1rem; border: 1px solid #ddd; border-radius: 8px;"></textarea>
            <div style="margin-top: 1rem;">
                <label>메모 (선택)</label>
                <input type="text" id="memo"
                    style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 8px;">
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="prevStep('D')">이전</button>
                <button class="btn" onclick="saveRecord()">저장하기</button>
            </div>
        </div>
    </form>
</div>

<style>
    .step-indicator.active {
        color: var(--accent-color);
        border-bottom: 2px solid var(--accent-color);
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    let currentStep = 'A';
    const steps = ['A', 'B', 'C', 'D', 'E'];

    function showStep(stepId) {
        document.querySelectorAll('.wizard-step').forEach(el => el.style.display = 'none');
        document.getElementById(`step-${stepId}-content`).style.display = 'block';

        // Update indicators
        document.querySelectorAll('.step-indicator').forEach(el => el.classList.remove('active'));
        for (let s of steps) {
            document.getElementById(`step-${s}`).classList.add('active');
            if (s === stepId) break;
        }
    }

    function nextStep(stepId) {
        // Validation could go here
        currentStep = stepId;
        showStep(stepId);
    }

    function prevStep(stepId) {
        currentStep = stepId;
        showStep(stepId);
    }

    function saveRecord() {
        const data = {
            adversity: document.getElementById('adversity').value,
            belief: document.getElementById('belief').value,
            consequence: document.getElementById('consequence').value,
            disputation: document.getElementById('disputation').value,
            effect: document.getElementById('effect').value,
            memo: document.getElementById('memo').value
        };

        fetch('/api/save_abcde', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('저장되었습니다.');
                    window.location.href = "{{ url_for('home') }}";
                } else {
                    alert('저장 실패');
                }
            });
    }

    function refreshQuestion() {
        fetch('/api/get_question')
            .then(res => res.json())
            .then(data => {
                document.getElementById('ai-question').innerText = data.question;
            });
    }
</script>
{% endblock %}